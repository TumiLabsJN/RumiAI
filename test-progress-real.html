<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Progress Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .test-card { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 1rem 0; }
        .btn { background: #FF6B35; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn:hover { background: #e55a2b; }
        .progress-container { margin: 2rem 0; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 1rem 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #FF6B35, #F7931E); border-radius: 4px; transition: width 0.3s ease; width: 0%; }
        .progress-info { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; }
        #results { background: #f8f9fa; border-radius: 6px; padding: 1rem; margin: 1rem 0; font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-card">
        <h2>🚀 Real Progress Test</h2>
        <p>Test the improved progress system with actual API calls:</p>
        
        <button class="btn" onclick="testRealAnalysis()">Test Real Analysis Progress</button>
        <button class="btn" onclick="clearResults()">Clear Results</button>
        
        <div class="progress-container">
            <div class="progress-info">
                <span id="progress-message">Ready to test...</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function updateProgress(percent, message) {
            document.getElementById('progress-percent').textContent = percent + '%';
            document.getElementById('progress-message').textContent = message;
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `[${timestamp}] ${message}\\n`;
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            updateProgress(0, 'Ready to test...');
        }

        async function testRealAnalysis() {
            log('🚀 Starting real analysis test...');
            
            try {
                updateProgress(0, 'Initializing Analysis...');
                log('📊 Phase 1: Initialization');
                await delay(800);
                
                updateProgress(10, 'Connecting to TikTok via Apify...');
                log('🌐 Phase 2: API Connection');
                
                // Start dynamic progress during API call
                let currentPercent = 15;
                const messages = [
                    'Scraping TikTok videos...',
                    'Scraping TikTok videos (processing data...)',
                    'Scraping TikTok videos (analyzing patterns...)',
                    'Scraping TikTok videos (calculating metrics...)'
                ];
                
                let messageIndex = 0;
                const progressInterval = setInterval(() => {
                    if (currentPercent < 30) {
                        currentPercent += 0.5;
                        if (Math.floor(currentPercent) % 3 === 0) {
                            messageIndex = (messageIndex + 1) % messages.length;
                        }
                        updateProgress(Math.floor(currentPercent), messages[messageIndex]);
                    }
                }, 300);
                
                log('📱 Making real API call to /api/tiktok/analyze...');
                
                // Make real API call
                const response = await fetch('/api/tiktok/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'testprogress' })
                });
                
                clearInterval(progressInterval);
                log(`📡 API Response: ${response.status}`);
                
                updateProgress(35, 'Processing video data...');
                log('🔄 Phase 3: Data Processing');
                await delay(800);
                
                updateProgress(45, 'Filtering qualifying videos...');
                await delay(600);
                
                updateProgress(55, 'Preparing comprehensive metadata analysis...');
                log('🧠 Phase 4: Intelligence Analysis');
                
                // Dynamic progress for analysis
                let analysisPercent = 60;
                const analysisMessages = [
                    'Analyzing engagement patterns...',
                    'Analyzing engagement patterns (processing data...)',
                    'Analyzing engagement patterns (calculating metrics...)'
                ];
                let analysisIndex = 0;
                
                const analysisInterval = setInterval(() => {
                    if (analysisPercent < 80) {
                        analysisPercent += 0.7;
                        if (Math.floor(analysisPercent) % 4 === 0) {
                            analysisIndex = (analysisIndex + 1) % analysisMessages.length;
                        }
                        updateProgress(Math.floor(analysisPercent), analysisMessages[analysisIndex]);
                    }
                }, 250);
                
                // Make analysis API call
                log('🔍 Making analysis API call...');
                const analysisResponse = await fetch('/api/analysis/videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videos: [] })
                });
                
                clearInterval(analysisInterval);
                log(`📊 Analysis Response: ${analysisResponse.status}`);
                
                updateProgress(85, 'Generating professional report...');
                log('📋 Phase 5: Report Generation');
                await delay(800);
                
                updateProgress(95, 'Finalizing analytics dashboard...');
                await delay(600);
                
                updateProgress(100, 'Analysis Complete!');
                log('✅ Test completed successfully!');
                log('🎯 Key improvements verified:');
                log('   • No stuck progress bars');
                log('   • Smooth dynamic updates');
                log('   • Real-time status messages');
                log('   • Professional user experience');
                
            } catch (error) {
                log(`❌ Test error: ${error.message}`);
                updateProgress(0, 'Test failed');
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>